<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>像素俄罗斯方块</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pixel: {
                            black: '#000000',
                            white: '#FFFFFF',
                            gray: '#CCCCCC'
                        }
                    },
                    fontFamily: {
                        pixel: ['"Press Start 2P"', 'monospace']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-border {
                box-shadow: 0 0 0 2px #000;
            }
            .pixel-btn {
                position: relative;
                background-color: #fff;
                border: 2px solid #000;
                box-shadow: 4px 4px 0 #000;
                transition: all 0.1s ease;
                text-transform: uppercase;
            }
            .pixel-btn:active {
                transform: translate(2px, 2px);
                box-shadow: 2px 2px 0 #000;
            }
            .pixel-block {
                border: 1px solid rgba(0, 0, 0, 0.3);
            }
            .game-title {
                text-shadow: 3px 3px 0 #000;
                letter-spacing: 2px;
            }
            .game-panel {
                box-shadow: 0 0 0 4px #000, 8px 8px 0 rgba(0, 0, 0, 0.1);
            }
            .pixel-modal {
                box-shadow: 0 0 0 4px #000, 10px 10px 0 rgba(0, 0, 0, 0.3);
            }
            .pixel-button-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .control-button {
                padding: 6px 10px;
                font-size: 12px;
            }
            .instructions-item {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
            }
            .key-indicator {
                display: inline-block;
                min-width: 30px;
                padding: 2px 6px;
                border: 2px solid #000;
                text-align: center;
                font-size: 12px;
            }
            .confirm-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                z-index: 100;
                align-items: center;
                justify-content: center;
            }
            .confirm-content {
                background-color: white;
                padding: 20px;
                border-radius: 5px;
                max-width: 300px;
                width: 90%;
                text-align: center;
            }
            .confirm-buttons {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: 20px;
            }
            .game-container {
                display: flex;
                gap: 1rem;
                align-items: flex-start;
                justify-content: center;
                width: 100%;
                margin: 0 auto;
            }
            .game-area {
                flex: 3;
                min-width: 180px;
            }
            .info-panel {
                flex: 1;
                min-width: 100px;
            }
            .next-preview-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                aspect-ratio: 1/1;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-pixel-white text-pixel-black min-h-screen flex flex-col items-center justify-center p-4 font-pixel overflow-hidden">
    <!-- 游戏主容器 -->
    <div class="game-container">
        <!-- 游戏区域 -->
        <div class="game-area">
            <div class="game-panel bg-pixel-gray p-2 relative rounded-sm w-full">
                <canvas id="gameCanvas" width="200" height="400" class="bg-pixel-white rounded-sm w-full"></canvas>
                <!-- 游戏开始界面 -->
                <div id="startScreen" class="absolute inset-0 bg-pixel-black/90 flex flex-col items-center justify-center p-6">
                    <h1 class="game-title text-2xl md:text-3xl text-pixel-white mb-10 text-center leading-tight">
                        像素俄罗斯方块
                    </h1>
                    <div class="bg-pixel-white/10 p-4 rounded-sm mb-8 max-w-xs">
                        <p id="startInstructions" class="text-pixel-white text-center text-sm leading-relaxed">
                            使用方向键控制方块移动<br>
                            上键：旋转方块<br>
                            空格键：快速下落<br>
                            P键：暂停游戏
                        </p>
                    </div>
                    <button id="startButton" class="pixel-btn px-8 py-4 text-lg font-bold">
                        开始游戏
                    </button>
                </div>
                <!-- 游戏结束界面 -->
                <div id="gameOverScreen" class="absolute inset-0 bg-pixel-black/90 flex flex-col items-center justify-center p-6 hidden">
                    <h2 class="text-2xl text-pixel-white mb-6">游戏结束</h2>
                    <div class="bg-pixel-white/10 p-4 rounded-sm mb-8">
                        <p id="finalScore" class="text-pixel-white mb-0 text-xl">得分: 0</p>
                    </div>
                    <button id="restartButton" class="pixel-btn px-8 py-4 text-lg font-bold">
                        重开游戏
                    </button>
                </div>
                <!-- 游戏暂停界面 -->
                <div id="pauseScreen" class="absolute inset-0 bg-pixel-black/90 flex flex-col items-center justify-center p-6 hidden">
                    <h2 class="text-2xl text-pixel-white mb-8">游戏暂停</h2>
                    <div class="pixel-button-group w-full max-w-xs">
                        <button id="resumeButton" class="pixel-btn control-button">
                            继续游戏
                        </button>
                        <button id="restartFromPauseButton" class="pixel-btn control-button">
                            重开游戏
                        </button>
                    </div>
                </div>
                <!-- 操作说明界面 -->
                <div id="instructionsScreen" class="absolute inset-0 bg-pixel-black/90 flex flex-col items-center justify-center p-4 hidden">
                    <div class="pixel-modal pixel-border bg-pixel-white p-5 w-full max-w-md rounded-sm">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="text-lg font-bold">操作说明</h2>
                            <button id="closeInstructionsButton" class="pixel-btn p-1 rounded-sm">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div id="instructionsContent" class="text-sm space-y-3">
                            <!-- 操作说明内容将通过JavaScript动态更新 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 信息面板区域 -->
        <div class="info-panel">
            <!-- 分数、等级和最高分 -->
            <div class="pixel-border bg-pixel-gray p-3 rounded-sm">
                <div class="mb-3">
                    <h2 class="text-xs mb-1 font-bold text-center">分数</h2>
                    <div id="score" class="text-xl tracking-wider text-center">0</div>
                </div>
                <div class="mb-3">
                    <h2 class="text-xs mb-1 font-bold text-center">等级</h2>
                    <div id="level" class="text-xl tracking-wider text-center">1</div>
                </div>
                <div>
                    <h2 class="text-xs mb-1 font-bold text-center">最高分</h2>
                    <div id="highScore" class="text-xl tracking-wider text-center">0</div>
                </div>
            </div>
            
            <!-- 下一个方块预览 -->
            <div id="nextPreviewContainer" class="pixel-border bg-pixel-gray p-3 rounded-sm next-preview-container">
                <h2 class="text-xs mb-2 font-bold text-center">下一个</h2>
                <div class="flex justify-center w-full h-auto">
                    <canvas id="nextCanvas" width="80" height="80" class="rounded-sm w-full h-auto aspect-square"></canvas>
                </div>
            </div>
            
            <!-- 控制按钮 -->
            <div class="flex flex-col gap-2">
                <button id="pauseButton" class="pixel-btn control-button text-xs" disabled>
                    暂停游戏
                </button>
                <button id="resetButton" class="pixel-btn control-button text-xs" disabled>
                    重开游戏
                </button>
                <button id="instructionsButton" class="pixel-btn control-button text-xs">
                    操作说明
                </button>
            </div>
        </div>
    </div>
    
    <!-- 底部信息区域 -->
    <div class="w-full max-w-xs mt-4 text-center text-xs opacity-70">
        <p>陈省安制作</p>
        <p>像素俄罗斯方块 &copy;  2025丨0.21.1</p>
    </div>
    
    <!-- 重新开始确认模态框 -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content pixel-border">
            <h3 class="font-bold mb-4">确认重开游戏？</h3>
            <p class="text-sm mb-4">当前游戏进度将被重置</p>
            <div class="confirm-buttons">
                <button id="confirmYes" class="pixel-btn px-4 py-2">是</button>
                <button id="confirmNo" class="pixel-btn px-4 py-2">否</button>
            </div>
        </div>
    </div>

    <script>
        // 检测是否为移动端
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // 游戏常量
        const ROWS = 20;
        const COLS = 10;
        let BLOCK_SIZE = 20; // 初始值，将根据屏幕尺寸调整
        const MOBILE_DROP_SPEED = 50; // 移动端向下滑动加速下落的速度（毫秒）
        // 减慢移动端左右移动速度，增加延迟
        const MOBILE_INITIAL_MOVE_DELAY = 600; // 首次移动延迟（毫秒）
        const MOBILE_CONTINUOUS_MOVE_DELAY = 600; // 连续移动延迟（毫秒）
        
        // 获取DOM元素
        const gameContainer = document.querySelector('.game-container');
        const gameArea = document.querySelector('.game-area');
        const infoPanel = document.querySelector('.info-panel');
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');
        const nextCanvas = document.getElementById('nextCanvas');
        const nextCtx = nextCanvas.getContext('2d');
        const nextPreviewContainer = document.getElementById('nextPreviewContainer'); // 获取预览容器
        
        // 获取其他DOM元素
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const pauseScreen = document.getElementById('pauseScreen');
        const instructionsScreen = document.getElementById('instructionsScreen');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const resetButton = document.getElementById('resetButton');
        const restartFromPauseButton = document.getElementById('restartFromPauseButton');
        const instructionsButton = document.getElementById('instructionsButton');
        const closeInstructionsButton = document.getElementById('closeInstructionsButton');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const finalScoreElement = document.getElementById('finalScore');
        const startInstructions = document.getElementById('startInstructions');
        const instructionsContent = document.getElementById('instructionsContent');
        const highScoreElement = document.getElementById('highScore'); // 获取最高分元素
        
        // 确认模态框元素
        const confirmModal = document.getElementById('confirmModal');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        
        // 游戏状态
        let board = [];
        let currentPiece = null;
        let nextPiece = null;
        let score = 0;
        let level = 1;
        let gameSpeed = 1000; // 初始速度，毫秒
        let gameInterval = null;
        let mobileDropInterval = null; // 移动端加速下落的定时器
        let mobileMoveInterval = null; // 移动端左右移动的定时器
        let mobileMoveDirection = 0; // 移动端左右移动方向：-1左，1右，0停止
        let mobileInitialMoveTimer = null; // 移动端首次移动延迟定时器
        let gameStarted = false;
        let gamePaused = false;
        let gameOver = false;
        // 初始化最高分
        let highScore = localStorage.getItem('highScore') ? parseInt(localStorage.getItem('highScore')) : 0;
        highScoreElement.textContent = highScore;
        
        // 方块形状定义（I, J, L, O, S, T, Z）
        const SHAPES = [
            [[1, 1, 1, 1]], // I
            [[1, 0, 0], [1, 1, 1]], // J
            [[0, 0, 1], [1, 1, 1]], // L
            [[1, 1], [1, 1]], // O
            [[0, 1, 1], [1, 1, 0]], // S
            [[0, 1, 0], [1, 1, 1]], // T
            [[1, 1, 0], [0, 1, 1]] // Z
        ];
        
        // 方块颜色
        const COLORS = [
            '#00FFFF', '#0000FF', '#FFA500', '#FFFF00', '#00FF00', '#800080', '#FF0000'
        ];

        // 触摸事件变量
        let touchStartX = 0;
        let touchStartY = 0;
        let lastTapTime = 0; // 上次点击时间，用于双击检测
        const MIN_SWIPE_DISTANCE = 10; // 最小滑动距离，减小阈值使响应更灵敏
        const TAP_TIMEOUT = 300; // 点击超时时间（毫秒）

        // 锁定/解锁页面滚动
        function lockScroll() {
            document.body.style.overflow = 'hidden';
        }
        
        function unlockScroll() {
            document.body.style.overflow = '';
        }

        // 初始化游戏
        function initGame() {
            // 初始化游戏板
            board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            
            // 初始化分数和等级
            score = 0;
            level = 1;
            updateScore();
            
            // 生成第一个方块和下一个方块
            currentPiece = generatePiece();
            nextPiece = generatePiece();
            
            // 绘制游戏板和方块
            drawBoard();
            drawNextPiece();
            
            // 重置游戏状态
            gameStarted = true;
            gamePaused = false;
            gameOver = false;
            
            // 隐藏所有屏幕
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            pauseScreen.classList.add('hidden');
            instructionsScreen.classList.add('hidden');
            confirmModal.style.display = 'none';
            
            // 锁定页面滚动
            lockScroll();
            
            // 启用重开和暂停按钮
            pauseButton.disabled = false;
            resetButton.disabled = false;

            // 开始游戏循环
            startGameLoop();
        }
        
        // 生成新方块
        function generatePiece() {
            const randomIndex = Math.floor(Math.random() * SHAPES.length);
            const shape = SHAPES[randomIndex];
            const color = COLORS[randomIndex];
            
            // 计算方块初始位置（居中）
            const x = Math.floor((COLS - shape[0].length) / 2);
            const y = 0;
            
            return {
                shape,
                color,
                x,
                y
            };
        }
        
        // 开始游戏循环
        function startGameLoop() {
            // 清除之前的游戏循环
            if (gameInterval) {
                clearInterval(gameInterval);
            }
            
            // 根据等级设置游戏速度
            gameSpeed = 1000 - (level - 1) * 100;
            gameSpeed = Math.max(100, gameSpeed); // 最小速度为100毫秒
            
            // 设置新的游戏循环
            gameInterval = setInterval(moveDown, gameSpeed);
        }
        
        // 向下移动方块
        function moveDown() {
            if (gamePaused || gameOver) return;
            
            if (canMove(currentPiece, 0, 1)) {
                currentPiece.y++;
            } else {
                // 方块不能再移动，固定到游戏板上
                mergePiece();
                
                // 清除加速下落定时器
                if (mobileDropInterval) {
                    clearInterval(mobileDropInterval);
                    mobileDropInterval = null;
                }
                
                // 清除左右移动定时器
                if (mobileMoveInterval) {
                    clearInterval(mobileMoveInterval);
                    mobileMoveInterval = null;
                }
                if (mobileInitialMoveTimer) {
                    clearTimeout(mobileInitialMoveTimer);
                    mobileInitialMoveTimer = null;
                }
                mobileMoveDirection = 0;

                // 检查是否有完整的行可以消除
                checkLines();
                
                // 生成新的方块
                currentPiece = nextPiece;
                nextPiece = generatePiece();
                drawNextPiece();
                
                // 检查游戏是否结束
                if (!canMove(currentPiece, 0, 0)) {
                    gameOver = true;
                    clearInterval(gameInterval);
                    if (mobileDropInterval) {
                        clearInterval(mobileDropInterval);
                    }
                    if (mobileMoveInterval) {
                        clearInterval(mobileMoveInterval);
                    }
                    if (mobileInitialMoveTimer) {
                        clearTimeout(mobileInitialMoveTimer);
                    }
                    showGameOver();
                    // 游戏结束时解锁滚动
                    unlockScroll();
                    return;
                }
            }
            
            drawBoard();
        }
        
        // 向左移动方块
        function moveLeft() {
            if (gamePaused || gameOver) return;
            
            if (canMove(currentPiece, -1, 0)) {
                currentPiece.x--;
                drawBoard();
            }
        }
        
        // 向右移动方块
        function moveRight() {
            if (gamePaused || gameOver) return;
            
            if (canMove(currentPiece, 1, 0)) {
                currentPiece.x++;
                drawBoard();
            }
        }
        
        // 旋转方块
        function rotatePiece() {
            if (gamePaused || gameOver) return;
            
            // 跳过O型方块的旋转
            if (currentPiece.shape.length === 2 && currentPiece.shape[0].length === 2) {
                return;
            }
            
            // 复制当前形状并旋转
            const rotatedShape = [];
            for (let i = 0; i < currentPiece.shape[0].length; i++) {
                const newRow = [];
                for (let j = currentPiece.shape.length - 1; j >= 0; j--) {
                    newRow.push(currentPiece.shape[j][i]);
                }
                rotatedShape.push(newRow);
            }
            
            // 保存当前形状以便回退
            const oldShape = currentPiece.shape;
            currentPiece.shape = rotatedShape;
            
            // 检查旋转后是否可以移动，如果不能则回退
            if (!canMove(currentPiece, 0, 0)) {
                currentPiece.shape = oldShape;
            } else {
                drawBoard();
            }
        }
        
        // 快速下落
        function hardDrop() {
            if (gamePaused || gameOver) return;
            
            while (canMove(currentPiece, 0, 1)) {
                currentPiece.y++;
                score += 2; // 快速下落得分
            }
            
            updateScore();
            moveDown(); // 触发固定和新方块生成
        }
        
        // 检查方块是否可以移动到指定位置
        function canMove(piece, offsetX, offsetY) {
            const newX = piece.x + offsetX;
            const newY = piece.y + offsetY;
            
            // 检查边界
            for (let y = 0; y < piece.shape.length; y++) {
                for (let x = 0; x < piece.shape[y].length; x++) {
                    if (piece.shape[y][x]) {
                        // 检查边界
                        if (
                            newX + x < 0 ||
                            newX + x >= COLS ||
                            newY + y >= ROWS
                        ) {
                            return false;
                        }
                        
                        // 检查碰撞
                        if (newY + y >= 0 && board[newY + y][newX + x]) {
                            return false;
                        }
                    }
                }
            }
            
            return true;
        }
        
        // 将方块合并到游戏板上
        function mergePiece() {
            for (let y = 0; y < currentPiece.shape.length; y++) {
                for (let x = 0; x < currentPiece.shape[y].length; x++) {
                    if (currentPiece.shape[y][x]) {
                        if (currentPiece.y + y >= 0) {
                            board[currentPiece.y + y][currentPiece.x + x] = currentPiece.color;
                        }
                    }
                }
            }
        }
        
        // 检查并消除完整的行
        function checkLines() {
            let linesCleared = 0;
            let fullLines = [];
            
            for (let y = ROWS - 1; y >= 0; y--) {
                let isLineComplete = true;
                
                for (let x = 0; x < COLS; x++) {
                    if (!board[y][x]) {
                        isLineComplete = false;
                        break;
                    }
                }
                
                if (isLineComplete) {
                    fullLines.push(y);
                    linesCleared++;
                }
            }
            
            if (linesCleared > 0) {
                // 执行闪烁动画
                let flashCount = 0;
                const originalBoard = JSON.parse(JSON.stringify(board)); // 保存原始游戏板状态
                
                const flashInterval = setInterval(() => {
                    flashCount++;
                    if (flashCount % 2 === 0) {
                        // 显示完整行（使用原始颜色）
                        fullLines.forEach(line => {
                            for (let x = 0; x < COLS; x++) {
                                board[line][x] = originalBoard[line][x];
                            }
                        });
                    } else {
                        // 隐藏完整行
                        fullLines.forEach(line => {
                            for (let x = 0; x < COLS; x++) {
                                board[line][x] = 0;
                            }
                        });
                    }
                    drawBoard();
                    
                    if (flashCount >= 6) {
                        clearInterval(flashInterval);
                        
                        // 消除完整行
                        fullLines.forEach(line => {
                            board.splice(line, 1);
                            board.unshift(Array(COLS).fill(0));
                        });
                        
                        // 更新分数和等级
                        score += [100, 300, 500, 800][linesCleared - 1] * level;
                        level = Math.floor(score / 1000) + 1;
                        updateScore();
                        
                        // 如果等级提升，加快游戏速度
                        if (linesCleared > 1) {
                            startGameLoop();
                        }
                        
                        drawBoard();
                    }
                }, 150);
            }
        }
        
        // 更新分数和等级显示，并检查最高分
        function updateScore() {
            scoreElement.textContent = score;
            levelElement.textContent = level;

            // 检查是否超过最高分
            if (score > highScore) {
                highScore = score;
                highScoreElement.textContent = highScore;
                localStorage.setItem('highScore', highScore);
            }
        }
        
        // 绘制游戏板
        function drawBoard() {
            // 清空画布
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // 绘制游戏板上的方块
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (board[y][x]) {
                        drawBlock(gameCtx, x, y, board[y][x]);
                    }
                }
            }
            
            // 绘制当前方块
            if (currentPiece) {
                for (let y = 0; y < currentPiece.shape.length; y++) {
                    for (let x = 0; x < currentPiece.shape[y].length; x++) {
                        if (currentPiece.shape[y][x]) {
                            drawBlock(gameCtx, currentPiece.x + x, currentPiece.y + y, currentPiece.color);
                        }
                    }
                }
            }
        }
        
        // 绘制下一个方块预览（透明背景）
        function drawNextPiece() {
            // 清空画布（不填充背景色，保持透明）
            nextCtx.clearRect(0, 0, nextCanvas.width, nextCanvas.height);
            
            if (nextPiece) {
                // 计算居中位置
                const offsetX = (nextCanvas.width / BLOCK_SIZE - nextPiece.shape[0].length) / 2;
                const offsetY = (nextCanvas.height / BLOCK_SIZE - nextPiece.shape.length) / 2;
                
                // 绘制下一个方块
                for (let y = 0; y < nextPiece.shape.length; y++) {
                    for (let x = 0; x < nextPiece.shape[y].length; x++) {
                        if (nextPiece.shape[y][x]) {
                            drawBlock(nextCtx, offsetX + x, offsetY + y, nextPiece.color);
                        }
                    }
                }
            }
        }
        
        // 绘制单个方块
        function drawBlock(ctx, x, y, color) {
            // 绘制方块主体
            ctx.fillStyle = color;
            ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            
            // 绘制边框
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
        }
        
        // 显示游戏开始界面
        function showStartScreen() {
            startScreen.classList.remove('hidden');
            // 根据设备类型更新操作说明
            if (isMobile()) {
                startInstructions.innerHTML = '滑动屏幕控制方块移动<br>向上滑动/点击屏幕：旋转方块<br>向下滑动：加速下落';
            } else {
                startInstructions.innerHTML = '使用方向键控制方块移动<br>上键：旋转方块<br>空格键：快速下落<br>P键：暂停游戏';
            }
        }
        
        // 显示游戏结束界面
        function showGameOver() {
            finalScoreElement.textContent = `得分: ${score}`;
            gameOverScreen.classList.remove('hidden');
            // 游戏结束时解锁滚动
            unlockScroll();
            // 禁用重开和暂停按钮
            pauseButton.disabled = true;
            resetButton.disabled = true;
        }
        
        // 暂停游戏
        function pauseGame() {
            if (gameOver) return;
            
            gamePaused = true;
            pauseScreen.classList.remove('hidden');
            clearInterval(gameInterval);
            if (mobileDropInterval) {
                clearInterval(mobileDropInterval);
            }
            if (mobileMoveInterval) {
                clearInterval(mobileMoveInterval);
            }
            if (mobileInitialMoveTimer) {
                clearTimeout(mobileInitialMoveTimer);
            }
            mobileMoveDirection = 0;
            // 暂停时解锁滚动
            unlockScroll();
        }
        
        // 恢复游戏
        function resumeGame() {
            gamePaused = false;
            pauseScreen.classList.add('hidden');
            instructionsScreen.classList.add('hidden');
            confirmModal.style.display = 'none';
            startGameLoop();
            // 恢复游戏时锁定滚动
            lockScroll();
        }
        
        // 显示操作说明并暂停游戏
        function showInstructions() {
            if (gameOver) return;
            
            gamePaused = true;
            instructionsScreen.classList.remove('hidden');
            clearInterval(gameInterval);
            if (mobileDropInterval) {
                clearInterval(mobileDropInterval);
            }
            if (mobileMoveInterval) {
                clearInterval(mobileMoveInterval);
            }
            if (mobileInitialMoveTimer) {
                clearTimeout(mobileInitialMoveTimer);
            }
            mobileMoveDirection = 0;
            
            // 根据设备类型更新操作说明内容
            if (isMobile()) {
                instructionsContent.innerHTML = `
                    <div class="instructions-item">
                        <span class="key-indicator">左右滑动</span>
                        <span>持续移动方块</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">向上滑动</span>
                        <span>旋转方块</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">点击屏幕</span>
                        <span>旋转方块</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">向下滑动</span>
                        <span>快速下落</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">P键</span>
                        <span>暂停游戏</span>
                    </div>
                `;
            } else {
                instructionsContent.innerHTML = `
                    <div class="instructions-item">
                        <span class="key-indicator">← →</span>
                        <span>移动方块</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">↑</span>
                        <span>旋转方块</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">↓</span>
                        <span>加速下落</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">空格</span>
                        <span>快速下落</span>
                    </div>
                    <div class="instructions-item">
                        <span class="key-indicator">P</span>
                        <span>暂停游戏</span>
                    </div>
                `;
            }
            
            // 显示说明时解锁滚动
            unlockScroll();
        }
        
        // 显示重新开始确认对话框
        function showConfirmDialog() {
            if (gameOver) {
                initGame(); // 如果游戏已经结束，直接重新开始
                return;
            }
            
            gamePaused = true;
            confirmModal.style.display = 'flex';
            clearInterval(gameInterval);
            if (mobileDropInterval) {
                clearInterval(mobileDropInterval);
            }
            if (mobileMoveInterval) {
                clearInterval(mobileMoveInterval);
            }
            if (mobileInitialMoveTimer) {
                clearTimeout(mobileInitialMoveTimer);
            }
            mobileMoveDirection = 0;
            // 显示确认对话框时解锁滚动
            unlockScroll();
        }
        
        // 调整游戏界面大小以适应屏幕
        function resizeGame() {
            // 获取可用空间
            const availableWidth = window.innerWidth - 80; // 减去左右边距
            const availableHeight = window.innerHeight - 120; // 减去上下边距
            
            // 计算游戏区域的理想宽度（游戏区域占3/4，信息面板占1/4）
            const idealGameWidth = availableWidth * 0.75;
            
            // 计算基于宽度的方块大小
            const blockSizeByWidth = Math.floor(idealGameWidth / COLS);
            
            // 计算基于高度的方块大小
            const blockSizeByHeight = Math.floor(availableHeight / ROWS);
            
            // 选择较小的方块大小，确保游戏能完整显示
            BLOCK_SIZE = Math.min(blockSizeByWidth, blockSizeByHeight);
            
            // 确保方块大小不会太小
            BLOCK_SIZE = Math.max(10, BLOCK_SIZE);
            
            // 设置游戏画布大小
            gameCanvas.width = COLS * BLOCK_SIZE;
            gameCanvas.height = ROWS * BLOCK_SIZE;
            
            // 计算预览画布的最大大小，确保不超过信息面板宽度
            const infoPanelWidth = infoPanel.offsetWidth;
            const maxNextCanvasSize = Math.min(4 * BLOCK_SIZE, infoPanelWidth - 6); // 减去左右内边距
            
            // 设置预览画布的实际像素尺寸
            nextCanvas.width = maxNextCanvasSize;
            nextCanvas.height = maxNextCanvasSize;
            
            // 使用CSS调整预览画布的显示大小，保持Canvas的实际像素尺寸
            nextCanvas.style.width = `${maxNextCanvasSize}px`;
            nextCanvas.style.height = `${maxNextCanvasSize}px`;
            
            // 重绘游戏
            if (gameStarted) {
                drawBoard();
                drawNextPiece();
            }
            
            // 更新UI字体大小和按钮大小以匹配游戏大小
            const fontSize = Math.max(8, BLOCK_SIZE * 0.6);
            document.documentElement.style.fontSize = `${fontSize}px`;
            
            // 调整按钮大小
            const buttons = document.querySelectorAll('.pixel-btn');
            buttons.forEach(button => {
                button.style.padding = `${BLOCK_SIZE * 0.2}px ${BLOCK_SIZE * 0.5}px`;
                button.style.fontSize = `${fontSize * 0.8}px`;
                button.style.boxShadow = `${BLOCK_SIZE * 0.2}px ${BLOCK_SIZE * 0.2}px 0 #000`;
            });
            
            // 调整信息面板中的元素
            const infoElements = document.querySelectorAll('.info-panel h2, .info-panel div');
            infoElements.forEach(element => {
                element.style.fontSize = `${fontSize * 0.7}px`;
            });
            
            // 调整操作说明中的元素
        }

        // 移动端左右移动处理
        function handleMobileMove(direction) {
            if (gamePaused || gameOver) return;

            if (mobileMoveDirection !== direction) {
                // 新的移动方向，设置首次移动延迟
                if (mobileInitialMoveTimer) {
                    clearTimeout(mobileInitialMoveTimer);
                }
                if (mobileMoveInterval) {
                    clearInterval(mobileMoveInterval);
                }
                mobileMoveDirection = direction;
                mobileInitialMoveTimer = setTimeout(() => {
                    move(direction);
                    mobileMoveInterval = setInterval(() => {
                        move(direction);
                    }, MOBILE_CONTINUOUS_MOVE_DELAY);
                }, MOBILE_INITIAL_MOVE_DELAY);
            }
        }

        function move(direction) {
            if (direction === -1) {
                moveLeft();
            } else if (direction === 1) {
                moveRight();
            }
        }

        // 触摸事件处理
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            const now = Date.now();
            if (now - lastTapTime < TAP_TIMEOUT) {
                rotatePiece();
            }
            lastTapTime = now;
        });

        document.addEventListener('touchmove', (e) => {
            if (gamePaused || gameOver) return;
            const touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;

            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > MIN_SWIPE_DISTANCE) {
                // 左右滑动
                const direction = dx > 0 ? 1 : -1;
                handleMobileMove(direction);
            } else if (dy > MIN_SWIPE_DISTANCE) {
                // 向下滑动
                if (!mobileDropInterval) {
                    mobileDropInterval = setInterval(moveDown, MOBILE_DROP_SPEED);
                }
            } else if (dy < -MIN_SWIPE_DISTANCE) {
                // 向上滑动
                rotatePiece();
            }
        });

        document.addEventListener('touchend', () => {
            if (mobileDropInterval) {
                clearInterval(mobileDropInterval);
                mobileDropInterval = null;
            }
            if (mobileMoveInterval) {
                clearInterval(mobileMoveInterval);
                mobileMoveInterval = null;
            }
            if (mobileInitialMoveTimer) {
                clearTimeout(mobileInitialMoveTimer);
                mobileInitialMoveTimer = null;
            }
            mobileMoveDirection = 0;
        });

        // 键盘事件处理
        document.addEventListener('keydown', (e) => {
            if (gamePaused && e.key !== 'p') return;
            switch (e.key) {
                case 'ArrowLeft':
                    moveLeft();
                    break;
                case 'ArrowRight':
                    moveRight();
                    break;
                case 'ArrowUp':
                    rotatePiece();
                    break;
                case 'ArrowDown':
                    moveDown();
                    break;
                case ' ':
                    hardDrop();
                    break;
                case 'p':
                    if (gameOver) return;
                    if (gamePaused) {
                        resumeGame();
                    } else {
                        pauseGame();
                    }
                    break;
            }
        });

        // 按钮事件处理
        startButton.addEventListener('click', initGame);
        restartButton.addEventListener('click', showConfirmDialog);
        pauseButton.addEventListener('click', pauseGame);
        resumeButton.addEventListener('click', resumeGame);
        resetButton.addEventListener('click', showConfirmDialog);
        restartFromPauseButton.addEventListener('click', showConfirmDialog);
        instructionsButton.addEventListener('click', showInstructions);
        closeInstructionsButton.addEventListener('click', resumeGame);
        confirmYes.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            initGame();
        });
        confirmNo.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            resumeGame();
        });

        // 初始化游戏显示开始界面
        showStartScreen();

        // 监听窗口大小变化
        window.addEventListener('resize', resizeGame);

        // 初始调整游戏界面大小
        resizeGame();
    </script>
</body>
</html>